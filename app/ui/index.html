<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>PDF Knowledge Chat</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; }
    #log { border: 1px solid #ddd; padding: 12px; height: 420px; overflow: auto; border-radius: 10px; }
    .msg { margin: 10px 0; }
    .you { font-weight: 700; }
    .bot { font-weight: 700; }
    textarea { width: 100%; height: 70px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
    .cite { font-size: 12px; color: #444; margin-top: 6px; }
  </style>
</head>
<body>
  <h2>PDF Knowledge Chat</h2>

  <h3>1) Ingest PDFs</h3>
  <input id="files" type="file" multiple accept="application/pdf"/>
  <button onclick="ingest()">Upload & Ingest</button>
  <div id="ingestStatus"></div>

  <h3>2) Chat</h3>
  <div id="log"></div>
  <textarea id="q" placeholder="Ask a question about the PDFs..."></textarea>
  <button onclick="ask()">Send</button>

<script>
const log = document.getElementById("log");

function addLine(who, text) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<div class="${who === 'You' ? 'you' : 'bot'}">${who}:</div><div>${text}</div>`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

async function ingest() {
  const files = document.getElementById("files").files;
  if (!files.length) return;

  const fd = new FormData();
  for (const f of files) fd.append("files", f);

  const res = await fetch("/ingest", { method: "POST", body: fd });
  const data = await res.json();
  document.getElementById("ingestStatus").innerText =
    `Ingested: ${data.files_ingested} files, added ${data.chunks_added} chunks`;
}

async function ask() {
  const q = document.getElementById("q").value.trim();
  if (!q) return;

  addLine("You", q);
  document.getElementById("q").value = "";

  const res = await fetch("/query", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ question: q })
  });

  const data = await res.json();

  let answer = data.answer;
  if (data.refusal_reason) {
    answer += `<div class="cite">Reason: ${data.refusal_reason}</div>`;
  }

  if (data.citations && data.citations.length) {
    answer += `<div class="cite"><b>Citations:</b><br/>` +
      data.citations.map((c,i) => {
        const pages = (c.page_start ? ` p.${c.page_start}` : "") +
                      (c.page_end && c.page_end !== c.page_start ? `-${c.page_end}` : "");
        return `[${i+1}] ${c.filename}${pages} (score ${c.score.toFixed(3)}) â€” ${c.excerpt}`;
      }).join("<br/>") +
      `</div>`;
  }

  addLine("Bot", answer);
}
</script>
</body>
</html>
